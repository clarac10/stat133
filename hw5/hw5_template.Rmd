---
title: "hw5"
author: "Clara Chun"
date: Due 11:59pm Wednesday, July 13, 2016
output: html_document
---

## Packages

The following packages are allowed for this assignment:
* rvest
* xml2
* ggplot2
* lubridate
* stringr
* dplyr
* tidyr
* readr
* scales
```{r setup, include=FALSE}
library(rvest)
library(ggplot2)
library(lubridate)
library(stringr)
library(dplyr)
library(tidyr)
library(readr)
library(scales)
```



## Nuclear Reactors

## Introduction
In this homework, you'll be scraping tables off the Wikipedia website.  The idea of doing this is always the same: find XPath expressions that lead to tables of interest, scrape them using `html_nodes()`, remove problem nodes with subsetting, and then converting the tables using `html_table()`.  Your goal is to produce the two graphs at the bottom of these instructions.

The aim of this assignment is to show you how dirty online data sources can be.  As you'll find out, finding and reading in the data will be the least of your worries.  You'll spend a good chunk of time thinking of how to clean the data before you can even think about plotting it! Do not despair---while there may not be enough examples in the world to show you every case you might come up against, the more you practice thinking about these issues on your own, the stronger your __intuition__ will become.

## Restrictions
To ensure that you are actually thinking about wrangling strategies, any manipulation of the data frame must be done with `dplyr` wrangling verbs (with the exception of renaming the columns).

__Bonus__: You may earn 10 bonus points if your code chunks:

* Never exceeds 80 characters in width
* Never calls on more than 3 functions per line
* Doesn't exceed 80 lines total

If you're using RStudio, the numbers on the bottom-left of the code panel show where the cursor is in the document.  Use this to check if you're within the limits.  You'll need to make full use of all the tools we've learned in class so far---from writing functions to using the `lapply` family.

## Starter Code
The starter code below should prime your thinking.  The angle brackets are __not__ literal.  Do not include them when running your code.
```{r, echo = T, fig.width=10}
page <- "http://en.wikipedia.org/wiki/List_of_nuclear_reactors"
xpath <- ".mediawiki .wikitable" 
table_list <- page %>%
  read_html() %>%
  html_nodes(xpath) %>%
  .[c(14,21)] %>%
  html_table(fill = TRUE)

new_names <- c("name", "reactor", "type", "model", "status", 
               "net", "gross", "const_start", "op_start", "closure")

names(table_list[[1]]) = new_names
names(table_list[[2]]) = new_names

fr.df = as.data.frame(table_list[[1]]) %>%
  slice(-c(1,51)) %>% 
  mutate(tname= "France")

jp.df = as.data.frame(table_list[[2]]) %>% 
  slice(-c(1)) %>%
  mutate(tname="Japan")
table_df = rbind(fr.df, jp.df)

rlvl = c("BWR", "FBR", "GCR", "HWGCR", "PWR")
rlbl = c("Boiling Water", "Fast Breeder", "Gas Cooled", 
         "Heavy Water Gas Cooled", "Pressurized Water")

#parse const_start to class "date" and parse net to class "numeric" and 
#set the 'type' column into factor with full names of reactors
table_df = table_df %>% 
  #filter(const_start !== NA)
  mutate(const_start = dmy(const_start)) %>% 
  mutate(net = as.numeric(net)) %>% 
  mutate(type=factor(type, rlvl, rlbl))

mindate = ymd("1955-01-01")
maxdate = ymd("2005-01-01")
ggplot(table_df, aes(const_start, net, shape=type, color=tname)) +
  geom_point(size=2) +
  labs(title="Net Reactor Capacities in France and Japan", 
       x="Construction Start Date",
       y="Net Capacity (MW)",
       color="Country",
       shape="Reactor Type") +
  scale_x_date(limits=c(mindate, maxdate), 
               labels=date_format("%Y")) +
  scale_y_continuous(limits=c(0,1500))
```

```{r, fig.height=7, fig.width=9}
jp.df = jp.df %>% 
  filter(op_start != "") %>% 
  mutate(const_start = dmy(const_start)) %>% 
  mutate(op_start = dmy(op_start)) %>%
  unite(name.reactor, name, reactor, sep="", remove=FALSE) %>% 
  mutate(name.reactor = factor(name.reactor, 
                               levels=sort(name.reactor, decreasing=TRUE),
                               ordered=TRUE)) %>% 
  mutate(type = factor(type, rlvl, rlbl)) %>% 
  mutate(nlbl = ifelse(
    str_detect(name.reactor, "1"), 
    str_replace_all(name.reactor, "1", ""), 
    character(1)))

datemin=ymd("1960-01-01")
datemax=ymd("2010-01-01")
ggplot(jp.df, 
       aes(x=const_start, y=name.reactor, 
           xend=op_start, yend=name.reactor, 
           color=type)) +
  geom_segment(size=0.5) +
  labs(title="Construction Times for Japanese Nuclear Reactors", 
       x="Date",
       y="Reactor Site",
       color="Reactor Type") +
  scale_x_date(limits=c(datemin, datemax), 
               breaks=seq(datemin, datemax, "5 years"), 
               labels=date_format("%Y")) +
  scale_y_discrete(labels=rev(jp.df$nlbl))
```

## Hints:
1. The US nuclear reactor table doesn't behave nicely---why? Read through the assumptions of `html_table`.
2. As you try to clean the French nuclear reactor data, one of the dates will not parse---why? You can ignore this particular row.
3. You'll need to fix the column names! No `dplyr` function will handle this correctly since the columns are not unique.  You'll have to rely on the class `names()` function.
4. The size of the points in the France-Japan scatterplot is 2.
5. The geometries in the Japan Construction graph are segments.
6. You'll have to play with the `breaks` and `labels` of both axes.
7. If you use `date_format`, you'll need to load the `ggplot2` library extension `scales`.
8. By default, strings are alphabetized for graphing.  If you turn the data into an ordered factor however...
9. All the reactors are present, but only one instance of the reactor name shows up for each reactor site.  For example `Tsuruga 1` and `Tsuruga 2` both show up under `Tsuruga` with the second one being represented by a tick with no label.
10. Empty strings don't show up...

